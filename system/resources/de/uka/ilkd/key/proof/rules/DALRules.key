// This file is part of KeYmaera
// Copyright (C) 2007 Andre Platzer
//
// The KeYmaera system is protected by the GNU General Public License. 
// See LICENSE.TXT for details.
//
// This file contains rules for handling hybrid programs


\include ruleSetsDeclarations;

\schemaVariables {
  \formula post, inv, augment;

  \variables R ep;
  \program OrdinaryDiffSystem #ordinarydiffsystem;
  \program DiffSystem #diffsystem,#newsys;
  \program DiffSystemWithIneq #diffsystemWithIneq;
}

\rules {
////////////////////////////////////////
//
// program rules
//
 
 diffind { \find (==> \[#ordinarydiffsystem\]post)
      \varcond(\isFirstOrderFormula(post))
    "Invariant Initially Valid":
          \replacewith (#invariantPart(\[#ordinarydiffsystem\]post) ==> post );
    "ODE Preserves Invariant":
          \replacewith (==>  #dlUniversalClosure(\[#ordinarydiffsystem\]true, #DiffInd(\[#ordinarydiffsystem\]post), false))
          \heuristics(invariant_diff,diff_rule)
		  \onlyRigidFunctions
          \displayname "DI differential invariant"
 }; 

 diffind_left { \find (\<#ordinarydiffsystem\>post ==>)
      \varcond(\isFirstOrderFormula(post))
    "Invariant Initially Valid":
          \replacewith (#invariantPart(\[#ordinarydiffsystem\]!post) ==> !post );
    "ODE Preserves Invariant":
          \replacewith (==>  #dlUniversalClosure(\[#ordinarydiffsystem\]true, #DiffInd(\[#ordinarydiffsystem\]!post), false))
          \heuristics(invariant_diff,diff_rule)
		  \onlyRigidFunctions
          \displayname "DI differential invariant"
 }; 

 difffin { \find (==> \<#ordinarydiffsystem\>post)
      \varcond(\isFirstOrderFormula(post), \notFreeIn(ep, post))
    "Invariant Sustained":
          \replacewith (==>  #weaknegateinv(\<#ordinarydiffsystem\>post));
    "Variant Progress":
          \replacewith (==>  \exists ep; (ep>0 & #dlUniversalClosure(\[#ordinarydiffsystem\]true, !post -> #DiffFin(\<#ordinarydiffsystem\>post, ep), false)))
          ///\replacewith (==>  #dlUniversalClosure(\[#ordinarydiffsystem\]true, !post -> #DiffFin(\<#ordinarydiffsystem\>post, 1), false))
          \heuristics(invariant_diff,diff_rule)
		  \onlyRigidFunctions
          \displayname "DV differential variant"
 }; 

 difffin_left { \find (\[#ordinarydiffsystem\]post ==>)
      \varcond(\isFirstOrderFormula(post), \notFreeIn(ep, post))
    "Invariant Sustained":
                    \replacewith (==>  #weaknegateinv(\<#ordinarydiffsystem\>!post));
    "Variant Progress":
          \replacewith (==>  \exists ep; (ep>0 & #dlUniversalClosure(\[#ordinarydiffsystem\]true, !post -> #DiffFin(\<#ordinarydiffsystem\>post, ep), false)))
          /// \replacewith (==>  #dlUniversalClosure(\[#ordinarydiffsystem\]true, post -> #DiffFin(\<#ordinarydiffsystem\>!post, 1), false))
          \heuristics(invariant_diff,diff_rule)
		  \onlyRigidFunctions
          \displayname "DV differential variant"
 }; 

 diffweaken { \find (==> \[#ordinarydiffsystem\]post)
          \replacewith (==>  #dlUniversalClosure(\[#ordinarydiffsystem\]true, #invariantPart(\[#ordinarydiffsystem\]post) -> post, false))
          \displayname "[DR'] differential weakening"
		  \onlyRigidFunctions
          \heuristics(invariant_weaken,diff_rule) 
 }; 

  //@todo should rename internally to diffcut with \oldname(diffstrenghten)
 diffstrengthen { \find (==> \[#ordinarydiffsystem\]post)
      \varcond(\isFirstOrderFormula(augment))
    "Invariant Valid":
          \replacewith (==> \[#ordinarydiffsystem\] augment );
    "Augmented Invariant":
          \replacewith (==>  #diffAdjoin(\[#ordinarydiffsystem\]post,augment))
          \heuristics(invariant_strengthen,diff_rule)
          \displayname "[DC] differential cut"
 }; 
 
 diffreplace_box_right { \find (==> \[#diffsystem\]post )
 	"System entailment":
 		\replacewith(==> #dlUniversalClosure(\[#diffsystem\]true, #dlimplies(\[#diffsystem\]true,\[#newsys\]true), false));
	"Generalisation":
		\replacewith(==> \[#newsys\] post)
		  \onlyRigidFunctions
		\displayname "[DR] differential refine"
};
 
 diffreplace_box_left { \find (\[#diffsystem\]post ==>)
 	"System entailment":
 		\replacewith(==> #dlUniversalClosure(\[#diffsystem\]true, #dlimplies(\[#newsys\]true,\[#diffsystem\]true), false));
	"Generalisation":
		\replacewith(\[#newsys\] post ==>)
		\heuristics(diff_ineq_weaken,diff_rule)
		  \onlyRigidFunctions
		\displayname "[DR] differential refine left" 	
};

 diffreplace_dia_right { \find (==> \<#diffsystem\>post )
 	"System entailment":
 		\replacewith(==> #dlUniversalClosure(\[#diffsystem\]true, #dlimplies(\[#newsys\]true,\[#diffsystem\]true), false));
	"Generalisation":
		\replacewith(==>\<#newsys\> post)
		\heuristics(diff_ineq_weaken,diff_rule)
		  \onlyRigidFunctions
		\displayname "<DR> differential refine" 	
};
 
 diffreplace_dia_left { \find (\<#diffsystem\>post ==>)
 	"System entailment":
 		\replacewith(==> #dlUniversalClosure(\[#diffsystem\]true, #dlimplies(\[#diffsystem\]true,\[#newsys\]true), false));
	"Generalisation":
		\replacewith(\<#newsys\> post ==>)
		  \onlyRigidFunctions
		\displayname "<DR> differential refine left" 	
};

}
